generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int              @id @default(autoincrement())
  githubId       String           @unique
  login          String
  avatarUrl      String?
  name           String?
  email          String?
  createdAt      DateTime         @default(now())

  githubAccessToken String?
  ownedProjects     Project[]        @relation("UserOwnedProjects")
  projectMembers    ProjectMember[]  @relation("UserProjectMembers")
  tasks             Task[]
}

model repository {
  repo_id        BigInt    @id
  name           String?   @db.VarChar(255)
  full_name      String?   @db.VarChar(255)
  private        Boolean?
  html_url       String?
  description    String?
  default_branch String?   @db.VarChar(255)
  language       String?   @db.VarChar(255)
  created_at     DateTime? @db.Timestamp(6)
  updated_at     DateTime? @db.Timestamp(6)
  pushed_at      DateTime? @db.Timestamp(6)
  owner_login    String?   @db.VarChar(255)

  commits commit[]
  files   file[]
  issues  issue[]
  pulls   pull[]

  projectRepositories ProjectRepository[]
  codeSummaries       CodeSummary[]
  tasks               Task[]

  summaries   Summary[]
  embeddings  Embedding[]
  contextMeta ContextMeta?
  graph       Graph?

  graphNodes  GraphNode[]   // <- FIXED: reverse relation
  graphEdges  GraphEdge[]   // <- FIXED: reverse relation
}

model commit {
  commit_sha   String    @id @db.VarChar(255)
  repo_id      BigInt?
  author_name  String?   @db.VarChar(255)
  author_email String?   @db.VarChar(255)   // <- FIXED typo
  date         DateTime? @db.Timestamp(6)
  message      String?
  parent_sha   String?   @db.VarChar(255)

  repository repository? @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
}

model file {
  file_id String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  repo_id BigInt?
  path    String
  sha     String? @db.VarChar(255)
  size    Int?
  type    String? @db.VarChar(50)
  content String? @db.Text

  repository repository? @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
}

model issue {
  issue_id     BigInt      @id
  repo_id      BigInt?
  issue_number Int?
  issue_url    String?
  author       Json?
  title        String?
  state        String?      @db.VarChar(50)
  created_at   DateTime?    @db.Timestamp(6)
  closed_at    DateTime?    @db.Timestamp(6)

  repository repository? @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
}

model pull {
  pull_id    BigInt       @id
  repo_id    BigInt?
  title      String?
  state      String?   @db.VarChar(50)
  created_at DateTime? @db.Timestamp(6)
  closed_at  DateTime? @db.Timestamp(6)

  repository repository? @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  ownerId     Int 

  owner   User    @relation("UserOwnedProjects", fields: [ownerId], references: [id], onDelete: Cascade)
  members ProjectMember[]
  repos   ProjectRepository[]
  summaries CodeSummary[]
  tasks     Task[]
  createdAt DateTime @default(now())
}

model ProjectMember {
  id        Int      @id @default(autoincrement())
  projectId Int
  userId    Int
  role      Role?

  project Project @relation(fields: [projectId], references: [id])
  user    User    @relation("UserProjectMembers", fields: [userId], references: [id], onDelete: Cascade)
}

enum Role {
  FRONTEND
  BACKEND
  AI
  DEVOPS
  DATABASE
  COMMON
}

enum TaskStatus {
  UNDONE
  IN_PROGRESS
  DONE
}

model ProjectRepository {
  id        Int    @id @default(autoincrement())
  projectId Int
  repo_id   BigInt

  project Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repo    repository @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
}

model Task {
  id             Int        @id @default(autoincrement())
  projectId      Int
  repo_id        BigInt?

  title          String
  description    String?
  status         TaskStatus @default(UNDONE)

  role           Role?
  assigneeUserId Int?
  assignee       User?      @relation(fields: [assigneeUserId], references: [id])

  source         String     @default("AI")
  runId          String?

  target         String?
  priority       String?
  taskType       String?
  category       String?
  confidence     Int?

  project        Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repository     repository? @relation(fields: [repo_id], references: [repo_id], onDelete: SetNull)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model CodeSummary {
  id          Int      @id @default(autoincrement())
  projectId   Int
  repo_id     BigInt?
  runId       String?
  summaryText String
  modelName   String?
  createdAt   DateTime @default(now())

  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repository  repository? @relation(fields: [repo_id], references: [repo_id], onDelete: SetNull)
}

model Summary {
  id        Int      @id @default(autoincrement())
  repo_id   BigInt
  filePath  String
  summary   String
  keywords  String[]
  quality   Float?
  createdAt DateTime @default(now())

  repository repository @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
  embedding  Embedding?
}

model Embedding {
  id          Int     @id @default(autoincrement())
  summaryId   Int     @unique
  fusedVector Json
  rawEdges    Json

  summary     Summary    @relation(fields: [summaryId], references: [id])
  repo_id     BigInt
  repository  repository @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
}

model ContextMeta {
  id        Int      @id @default(autoincrement())
  repo_id   BigInt   @unique
  metaJson  Json
  createdAt DateTime @default(now())

  repository repository @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
}

model Graph {
  id        Int      @id @default(autoincrement())
  repo_id   BigInt   @unique
  createdAt DateTime @default(now())

  repository repository @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
  nodes      GraphNode[]
  edges      GraphEdge[]
}

model GraphNode {
  id            BigInt   @id @default(autoincrement())
  repo_id       BigInt
  graphId       Int

  external_id   String
  label         String
  type          String?
  parent        String?
  size          Float?
  color         String?
  group         String?

  summary       String?
  logic         String?
  intent        String?
  structure     String?

  domain        String?
  importance    Float?

  createdAt     DateTime @default(now())

  graph         Graph      @relation(fields: [graphId], references: [id])
  repository    repository @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)

  edges_out     GraphEdge[] @relation("node_out")
  edges_in      GraphEdge[] @relation("node_in")
}

model GraphEdge {
  id        BigInt   @id @default(autoincrement())
  repo_id   BigInt
  graphId   Int

  from_id   BigInt
  to_id     BigInt
  relation  String
  metadata  Json?

  from      GraphNode  @relation("node_out", fields: [from_id], references: [id])
  to        GraphNode  @relation("node_in", fields: [to_id], references: [id])

  graph     Graph      @relation(fields: [graphId], references: [id])
  repository repository @relation(fields: [repo_id], references: [repo_id], onDelete: Cascade)
}
